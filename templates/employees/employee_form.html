{% extends "base.html" %}

{% block title %}
    {% if form.instance.pk %}
        Редактирование {{ form.instance.get_full_name }}
    {% else %}
        Новый сотрудник
    {% endif %}
{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">
                        {% if form.instance.pk %}
                            Редактирование сотрудника
                        {% else %}
                            Новый сотрудник
                        {% endif %}
                    </h1>

                    <form method="post" enctype="multipart/form-data" class="mt-4">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                {% for field in form %}
                                    {% if field.name != 'photo' %}
                                        <div class="mb-3">
                                            <label for="{{ field.id_for_label }}" 
                                                   class="form-label">
                                                {{ field.label }}
                                            </label>
                                            {{ field|addclass:"form-control" }}
                                            {% if field.help_text %}
                                                <div class="form-text">{{ field.help_text }}</div>
                                            {% endif %}
                                            {% if field.errors %}
                                                <div class="alert alert-danger mt-2">
                                                    {{ field.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.photo.id_for_label }}" 
                                           class="form-label">
                                        {{ form.photo.label }}
                                    </label>
                                    {% if form.instance.photo %}
                                        <img src="{{ form.instance.photo.url }}" 
                                             class="img-fluid mb-2" 
                                             id="photo-preview">
                                    {% else %}
                                        <img src="" class="img-fluid mb-2" 
                                             id="photo-preview" style="display: none;">
                                    {% endif %}
                                    {{ form.photo|addclass:"form-control" }}
                                    {% if form.photo.help_text %}
                                        <div class="form-text">{{ form.photo.help_text }}</div>
                                    {% endif %}
                                    {% if form.photo.errors %}
                                        <div class="alert alert-danger mt-2">
                                            {{ form.photo.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'employees:list' %}" 
                               class="btn btn-secondary me-md-2">
                                Отмена
                            </a>
                            <button type="submit" class="btn btn-primary">
                                {% if form.instance.pk %}
                                    Сохранить
                                {% else %}
                                    Создать
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Инициализация зависимых выпадающих списков
    document.addEventListener('DOMContentLoaded', function() {
        const organizationSelect = document.getElementById('id_organization');
        const departmentSelect = document.getElementById('id_department');
        const positionSelect = document.getElementById('id_position');

        // Обработчик изменения организации
        organizationSelect.addEventListener('change', function() {
            const organizationId = this.value;
            
            // Сброс и блокировка зависимых списков
            departmentSelect.innerHTML = '<option value="">---------</option>';
            positionSelect.innerHTML = '<option value="">---------</option>';
            departmentSelect.disabled = !organizationId;
            positionSelect.disabled = true;

            if (organizationId) {
                // Загрузка подразделений
                fetch(`/employees/ajax/departments/?organization=${organizationId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.departments.forEach(dept => {
                            const option = new Option(dept.name, dept.id);
                            departmentSelect.add(option);
                        });
                        departmentSelect.disabled = false;
                    });
            }
        });

        // Обработчик изменения подразделения
        departmentSelect.addEventListener('change', function() {
            const departmentId = this.value;
            
            // Сброс и блокировка списка должностей
            positionSelect.innerHTML = '<option value="">---------</option>';
            positionSelect.disabled = !departmentId;

            if (departmentId) {
                // Загрузка должностей
                fetch(`/employees/ajax/positions/?department=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.positions.forEach(pos => {
                            const option = new Option(pos.name, pos.id);
                            positionSelect.add(option);
                        });
                        positionSelect.disabled = false;
                    });
            }
        });

        // Предварительный просмотр фото
        const photoInput = document.getElementById('id_photo');
        const photoPreview = document.getElementById('photo-preview');

        photoInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
    });
</script>
{% endblock %}