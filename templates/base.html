import os
from pathlib import Path

def write_file(path, content, mode='w'):
    """Записывает содержимое в файл"""
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, mode, encoding='utf-8') as f:
        f.write(content)
    print(f"Обновлен файл: {path}")

def update_project():
    """Обновляет файлы проекта для реализации зависимых списков"""
    project_root = Path(__file__).parent.parent

    # 1. Обновляем конфигурацию URL
    config_urls_content = """from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('apps.core.urls')),
    path('organizations/', include('apps.organizations.urls')),
    path('employees/', include('apps.employees.urls')),
    path('departments/', include('apps.departments.urls')),
    path('documents/', include('apps.documents.urls')),
    path('importer/', include('apps.importer.urls')),
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
"""
    write_file(project_root / 'config' / 'urls.py', config_urls_content)

    # 2. Создаем/обновляем urls.py в departments
    departments_urls_content = """from django.urls import path
from . import views

app_name = 'departments'

urlpatterns = [
    path('by_organization/', views.get_departments_by_organization, name='get_departments'),
]
"""
    write_file(project_root / 'apps' / 'departments' / 'urls.py', departments_urls_content)

    # 3. Обновляем views.py в departments
    departments_views_content = """from django.http import JsonResponse
from .models import Department

def get_departments_by_organization(request):
    organization_id = request.GET.get('organization_id')
    print(f"Запрос подразделений для организации: {organization_id}")
    
    if organization_id:
        departments = Department.objects.filter(
            organization_id=organization_id
        ).values('id', 'name', 'short_name')
        data = list(departments)
        print(f"Найдены подразделения: {data}")
        return JsonResponse({'departments': data})
    
    return JsonResponse({'departments': []})
"""
    write_file(project_root / 'apps' / 'departments' / 'views.py', departments_views_content)

    # 4. Создаем JavaScript для зависимых списков
    js_content = """document.addEventListener('DOMContentLoaded', function() {
    const organizationSelect = document.getElementById('id_organization');
    const departmentSelect = document.getElementById('id_department');

    function resetSelect(select, defaultText = '---------') {
        select.innerHTML = `<option value="">${defaultText}</option>`;
        select.disabled = true;
    }

    if (organizationSelect) {
        console.log('Найден select организации');
        
        organizationSelect.addEventListener('change', function() {
            const organizationId = this.value;
            console.log('Выбрана организация:', organizationId);

            resetSelect(departmentSelect, 'Выберите подразделение');

            if (organizationId) {
                const url = `/departments/by_organization/?organization_id=${organizationId}`;
                console.log('Отправка запроса:', url);

                fetch(url)
                    .then(response => {
                        console.log('Получен ответ:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Получены данные:', data);
                        
                        if (data.departments && data.departments.length > 0) {
                            departmentSelect.disabled = false;
                            data.departments.forEach(dept => {
                                const option = new Option(
                                    dept.short_name || dept.name,
                                    dept.id
                                );
                                departmentSelect.add(option);
                            });
                        } else {
                            console.log('Нет подразделений для этой организации');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при загрузке подразделений:', error);
                        resetSelect(departmentSelect, 'Ошибка загрузки');
                    });
            }
        });

        // Если уже выбрана организация при загрузке страницы
        if (organizationSelect.value) {
            organizationSelect.dispatchEvent(new Event('change'));
        }
    }

    // Обработчик предпросмотра фото
    const photoInput = document.getElementById('id_photo');
    const photoPreview = document.getElementById('photo-preview');

    if (photoInput && photoPreview) {
        photoInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
    }
});
"""
    write_file(project_root / 'static' / 'js' / 'dependent_dropdowns.js', js_content)

    # 5. Обновляем шаблон employee_form.html
    template_content = """{% extends "base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}
Редактирование {{ form.instance.get_full_name }}
{% else %}
Новый сотрудник
{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">
                    {% if form.instance.pk %}
                    Редактирование сотрудника
                    {% else %}
                    Новый сотрудник
                    {% endif %}
                </h1>

                <form method="post" enctype="multipart/form-data" class="mt-4">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-8">
                            {% for field in form %}
                            {% if field.name != 'photo' %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {{ field.label }}
                                </label>
                                {{ field|addclass:"form-control" }}
                                {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                <div class="alert alert-danger mt-2">
                                    {{ field.errors }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.photo.id_for_label }}" class="form-label">
                                    {{ form.photo.label }}
                                </label>
                                {% if form.instance.photo %}
                                <img src="{{ form.instance.photo.url }}" class="img-fluid mb-2" id="photo-preview">
                                {% else %}
                                <img src="" class="img-fluid mb-2" id="photo-preview" style="display: none;">
                                {% endif %}
                                {{ form.photo|addclass:"form-control" }}
                                {% if form.photo.help_text %}
                                <div class="form-text">{{ form.photo.help_text }}</div>
                                {% endif %}
                                {% if form.photo.errors %}
                                <div class="alert alert-danger mt-2">
                                    {{ form.photo.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'employees:list' %}" class="btn btn-secondary me-md-2">
                            Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if form.instance.pk %}
                            Сохранить
                            {% else %}
                            Создать
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/dependent_dropdowns.js' %}"></script>
{% endblock %}
"""
    write_file(project_root / 'templates' / 'employee_form.html', template_content)

    print("\nОбновление проекта завершено успешно!")
    print("\nНеобходимые действия:")
    print("1. Выполните команду: python manage.py collectstatic")
    print("2. Перезапустите сервер Django: python manage.py runserver")
    print("3. Проверьте работу зависимых списков в форме сотрудника")
    print("\nДля отладки:")
    print("1. Откройте консоль браузера (F12)")
    print("2. Проверьте вкладку Network при выборе организации")
    print("3. Убедитесь, что запросы отправляются на правильный URL")

if __name__ == '__main__':
    try:
        update_project()
    except Exception as e:
        print(f"Ошибка при обновлении проекта: {e}")